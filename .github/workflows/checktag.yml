##on:
##  push:
##    tags:
##      # See https://docs.github.com/en/actions/reference/workflow-syntax-for-github-actions#filter-pattern-cheat-sheet
##      - 'v[0-9].[0-9]*'

on: [push, pull_request]

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2

      - name: Dump GitHub context
        env:
          GITHUB_CONTEXT: ${{ toJson(github) }}
        run: echo "$GITHUB_CONTEXT"

      - name: Dump event JSON
        env:
          EVENT_JSON_FILENAME: ${{ github.event_path }}
        run: cat "$EVENT_JSON_FILENAME"

      - name: make -C tests checkTag
        if: startsWith(github.ref, 'refs/tags/v')   # If git tag name starts with 'v'
        run: |
          echo "tag=${GITHUB_REF#refs/*/}"
          make -C tests checkTag
          tests/checkTag ${GITHUB_REF#refs/*/}

      - name: Tag check
        if: startsWith(github.ref, 'refs/tags/v[0-9]')
        run: |
          echo "TAG v[0-9]"
          echo "GITHUB_REF=${GITHUB_REF}"

      - name: Tag check
        if: startsWith(github.ref, 'refs/tags/v*.*')
        run: |
          echo "TAG v*.*"
          echo "GITHUB_REF=${GITHUB_REF}"

      - name: Set env
        run: |
          echo 1=${GITHUB_REF#refs/*/}
          echo "GITHUB_REF=${GITHUB_REF}"
          echo "RELEASE_VERSION=${GITHUB_REF#refs/*/}" >> $GITHUB_ENV

      - name: Test
        run: |
          echo $RELEASE_VERSION
          echo ${{ env.RELEASE_VERSION }}
