# Test various C compilers
name: C Compilers
on: [push, pull_request]
jobs:
  lz4-c-compilers:
    name: $CC=${{ matrix.cc }}, ${{ matrix.os }}, c-compilers.yml
    strategy:
      fail-fast: false  # 'false' means Don't stop matrix workflows even if some matrix failed.
      matrix:
        include: [
          # You can access the following values via ${{ matrix.??? }}
          #   name : Label name.
          #   pkgs : apt-get package names.  You can include multiple package names which are delimited by space.
          #   cc   : C compiler executable.
          #   cxx  : C++ compiler executable for `make ctocpptest`.
          #   stdc90 : Set 'true' if compiler supports C90 standard.
          #   stdc11 : Set 'true' if compiler supports C11 standard.
          #   m32  : Set 'true' if compiler supports x32. Set 'fail' if it supports x32 but fails for now.
          #   x86  : Set 'true' if compiler supports x86 (-m32). Set 'fail' if it supports x86 but fails for now.
          #   os   : GitHub Actions YAML workflow label.  See https://github.com/actions/virtual-environments#available-environments

          # cc
          { pkgs: '',                                                   cc: cc,        cxx: c++,         stdc11: 'true',  stdc90: 'true',  x32: 'true',  x86: 'true', cxxtest: 'true', os: ubuntu-latest, },

          # gcc
          { pkgs: '',                                                   cc: gcc,       cxx: g++,         stdc11: 'true',  stdc90: 'true',  x32: 'true',  x86: 'true', cxxtest: 'true', os: ubuntu-latest, },
          { pkgs: 'gcc-11 lib32gcc-11-dev libx32gcc-11-dev',            cc: gcc-11,    cxx: g++-11,      stdc11: 'true',  stdc90: 'true',  x32: 'fail',  x86: 'fail', cxxtest: 'true', os: ubuntu-20.04,  }, # x32: https://github.com/t-mat/lz4/runs/2701644803?check_suite_focus=true#step:17:1621
          { pkgs: 'gcc-10 lib32gcc-10-dev libx32gcc-10-dev',            cc: gcc-10,    cxx: g++-10,      stdc11: 'true',  stdc90: 'true',  x32: 'true',  x86: 'true', cxxtest: 'true', os: ubuntu-20.04,  }, # 
          { pkgs: 'gcc-9 lib32gcc-9-dev libx32gcc-9-dev',               cc: gcc-9,     cxx: g++-9,       stdc11: 'true',  stdc90: 'true',  x32: 'true',  x86: 'true', cxxtest: 'true', os: ubuntu-20.04,  },
          { pkgs: 'gcc-8 g++-8 lib32gcc-8-dev libx32gcc-8-dev',         cc: gcc-8,     cxx: g++-8,       stdc11: 'true',  stdc90: 'true',  x32: 'true',  x86: 'true', cxxtest: 'true', os: ubuntu-20.04,  },
          { pkgs: 'gcc-7 g++-7 lib32gcc-7-dev libx32gcc-7-dev',         cc: gcc-7,     cxx: g++-7,       stdc11: 'true',  stdc90: 'true',  x32: 'true',  x86: 'true', cxxtest: 'true', os: ubuntu-20.04,  },
          { pkgs: 'gcc-6 g++-6 lib32gcc-6-dev libx32gcc-6-dev',         cc: gcc-6,     cxx: g++-6,       stdc11: 'true',  stdc90: 'true',  x32: 'true',  x86: 'true', cxxtest: 'true', os: ubuntu-18.04,  },
          { pkgs: 'gcc-5 g++-5 lib32gcc-5-dev libx32gcc-5-dev',         cc: gcc-5,     cxx: g++-5,       stdc11: 'true',  stdc90: 'true',  x32: 'true',  x86: 'true', cxxtest: 'true', os: ubuntu-18.04,  },
          { pkgs: 'gcc-4.8 g++-4.8 lib32gcc-4.8-dev libx32gcc-4.8-dev', cc: gcc-4.8,   cxx: g++-4.8,     stdc11: 'true',  stdc90: 'true',  x32: 'true',  x86: 'true', cxxtest: 'true', os: ubuntu-18.04,  },
          { pkgs: 'gcc-4.7 g++-4.7 lib32gcc-4.7-dev',                   cc: gcc-4.7,   cxx: g++-4.7,     stdc11: 'true',  stdc90: 'true',  x32: 'false', x86: 'true', cxxtest: 'true', os: ubuntu-16.04,  }, # x32: gcc-4.7 partially support x32. But seems unreliable.
          { pkgs: 'gcc-4.6 g++-4.6 gcc-4.6-multilib',                   cc: gcc-4.6,   cxx: g++-4.6,     stdc11: 'false', stdc90: 'true',  x32: 'false', x86: 'true', cxxtest: 'true', os: ubuntu-16.04,  }, # x32: gcc-4.6 does't support x32.
          #{pkgs: 'gcc-4.5 g++-4.5',                                    cc: gcc-4.5,   cxx: g++-4.5,     stdc11: 'false', stdc90: 'true',  x32: 'false', x86: 'true', cxxtest: 'true', os: ubuntu-16.04,  }, # Failed to install gcc-4.5 to ubuntu-16.04.
          { pkgs: 'gcc-4.4 g++-4.4 gcc-4.4-multilib',                   cc: gcc-4.4,   cxx: g++-4.4,     stdc11: 'false', stdc90: 'false', x32: 'false', x86: 'true', cxxtest: 'true', os: ubuntu-16.04,  }, # stdc90, x32: gcc-4.4 doesn't support them.

          # clang
          { pkgs: 'lib32gcc-11-dev libx32gcc-11-dev',                   cc: clang,     cxx: clang++,     stdc11: 'true',  stdc90: 'true',  x32: 'fail',  x86: 'fail', cxxtest: 'true', os: ubuntu-latest, },
          { pkgs: 'clang-12  lib32gcc-11-dev libx32gcc-11-dev',         cc: clang-12,  cxx: clang++-12,  stdc11: 'true',  stdc90: 'true',  x32: 'fail',  x86: 'fail', cxxtest: 'true', os: ubuntu-20.04,  },
          { pkgs: 'clang-11  lib32gcc-11-dev libx32gcc-11-dev',         cc: clang-11,  cxx: clang++-11,  stdc11: 'true',  stdc90: 'true',  x32: 'fail',  x86: 'fail', cxxtest: 'true', os: ubuntu-20.04,  },
          { pkgs: 'clang-10  lib32gcc-11-dev libx32gcc-11-dev',         cc: clang-10,  cxx: clang++-10,  stdc11: 'true',  stdc90: 'true',  x32: 'fail',  x86: 'fail', cxxtest: 'true', os: ubuntu-20.04,  },
          { pkgs: 'clang-9   lib32gcc-11-dev libx32gcc-11-dev',         cc: clang-9,   cxx: clang++-9,   stdc11: 'true',  stdc90: 'true',  x32: 'fail',  x86: 'fail', cxxtest: 'true', os: ubuntu-20.04,  },
          { pkgs: 'clang-8   lib32gcc-11-dev libx32gcc-11-dev',         cc: clang-8,   cxx: clang++-8,   stdc11: 'true',  stdc90: 'true',  x32: 'fail',  x86: 'fail', cxxtest: 'true', os: ubuntu-20.04,  },
          { pkgs: 'clang-7   lib32gcc-7-dev  libx32gcc-7-dev',          cc: clang-7,   cxx: clang++-7,   stdc11: 'true',  stdc90: 'true',  x32: 'fail',  x86: 'fail', cxxtest: 'true', os: ubuntu-20.04,  },
          { pkgs: 'clang-6.0 lib32gcc-11-dev libx32gcc-11-dev',         cc: clang-6.0, cxx: clang++-6.0, stdc11: 'true',  stdc90: 'true',  x32: 'fail',  x86: 'fail', cxxtest: 'true', os: ubuntu-20.04,  },
          { pkgs: 'clang-5.0 lib32gcc-11-dev libx32gcc-11-dev',         cc: clang-5.0, cxx: clang++-5.0, stdc11: 'true',  stdc90: 'true',  x32: 'fail',  x86: 'fail', cxxtest: 'true', os: ubuntu-18.04,  },
          { pkgs: 'clang-4.0 lib32gcc-11-dev libx32gcc-11-dev',         cc: clang-4.0, cxx: clang++-4.0, stdc11: 'true',  stdc90: 'true',  x32: 'fail',  x86: 'fail', cxxtest: 'true', os: ubuntu-18.04,  },
          { pkgs: 'clang-3.9 lib32gcc-11-dev libx32gcc-11-dev',         cc: clang-3.9, cxx: clang++-3.9, stdc11: 'true',  stdc90: 'true',  x32: 'fail',  x86: 'fail', cxxtest: 'fail', os: ubuntu-18.04,  }, # cxxtest: clang-3.9 has issue about __STRICT_ANSI__. ignore.
          { pkgs: 'clang-3.8',                                          cc: clang-3.8, cxx: clang++-3.8, stdc11: 'true',  stdc90: 'true',  x32: 'fail',  x86: 'fail', cxxtest: 'true', os: ubuntu-16.04,  },
          { pkgs: 'clang-3.7',                                          cc: clang-3.7, cxx: clang++-3.7, stdc11: 'true',  stdc90: 'true',  x32: 'false', x86: 'fail', cxxtest: 'true', os: ubuntu-16.04,  }, # x32: clang-3.7 compiler clashes for x32. ignore.
          { pkgs: 'clang-3.6',                                          cc: clang-3.6, cxx: clang++-3.6, stdc11: 'true',  stdc90: 'true',  x32: 'false', x86: 'fail', cxxtest: 'true', os: ubuntu-16.04,  }, # x32: clang-3.6 compiler clashes for x32. ignore.
          { pkgs: 'clang-3.5',                                          cc: clang-3.5, cxx: clang++-3.5, stdc11: 'true',  stdc90: 'true',  x32: 'false', x86: 'fail', cxxtest: 'true', os: ubuntu-16.04,  }, # x32: clang-3.5 compiler clashes for x32. ignore.
        ]

    runs-on: ${{ matrix.os }}
    env:                        # Set environment variables
      # We globally set CC and CXX to improve compatibility with .travis.yml
      CC: ${{ matrix.cc }}
      CXX: ${{ matrix.cxx }}
    steps:
    - uses: actions/checkout@v2 # https://github.com/actions/checkout

    - name: apt-get install
      run: |
        sudo apt-get install gcc-multilib
        sudo apt-get install ${{ matrix.pkgs }}

    - name: Environment info
      run: |
        echo && which $CC
        echo && $CC --version
        echo && which $CXX
        echo && $CXX --version

####    - name: make
####      run: |
####        make V=1
####
####    - name: make all
####      run: |
####        make V=1 clean all
####
####    - name: make c_standards (C90)
####      if: ${{ matrix.stdc90 == 'true' }}
####      run: |
####        make V=1 clean c_standards_c90
####
####    - name: make c_standards (C11)
####      if: ${{ matrix.stdc11 == 'true' }}
####      run: |
####        make V=1 clean c_standards_c11
####
####    - name: make c-to-c++
####      run: |
####        make V=1 clean ctocpptest
####
####    - name: make cxxtest
####      if: ${{ matrix.cxxtest == 'true' }}
####      run: |
####        make V=1 clean cxxtest
####
####    - name: make -C programs default
####      run: |
####        make V=1 -C programs clean default
####
####    - name: make -C programs default -D_FORTIFY_SOURCE=2
####      run: |
####        CFLAGS='-fPIC' LDFLAGS='-pie -fPIE -D_FORTIFY_SOURCE=2' make V=1 -C programs clean default
####
####    - name: make -C tests test-lz4
####      run: |
####        MOREFLAGS='-Werror' make V=1 -C tests clean test-lz4
####
####    - name: make clangtest (clang only)
####      if: ${{ startsWith( matrix.cc , 'clang' ) }}
####      run: |
####        make V=1 clean clangtest
####
    - name: make -C tests test MOREFLAGS='-mx32'
      if: ${{ matrix.x32 == 'true' }}
      run: |
        LDFLAGS='-Wl,--verbose' MOREFLAGS='-mx32' make V=1 -C tests clean test

    - name: make -C tests test-lz4c32
      if: ${{ matrix.x86 == 'true' }}
      run: |
        LDFLAGS='-Wl,--verbose' MOREFLAGS='-Werror' make V=1 -C tests clean test-lz4c32


    ###############################################################
    #                                                             #
    #                                                             #
    #           Remove this block when we reach stable.           #
    #                                                             #
    #                                                             #
    # These area special case for during GH-Actions integration.  #
    #                                                             #
    # Indicates GREEN if test FAILS.                              #
    # Indicates RED if test SCCUESS.                              #
    #   If we see RED for these tests, we must update test case.  #
    #

    - name: make -C tests test MOREFLAGS='-mx32' || echo Ignore failure for now.
      if: ${{ matrix.x32 == 'fail' }}
      run: |
        ! LDFLAGS='-Wl,--verbose' MOREFLAGS='-mx32' make V=1 -C tests clean test || (echo SUCCESS!! but set RED to suggest to update the test case && $(exit 1))
        echo We ignore failure of this case for now.

    - name: make -C tests test-lz4c32 || echo Ignore failure for now.
      if: ${{ matrix.x86 == 'fail' }}
      run: |
        ! LDFLAGS='-Wl,--verbose' MOREFLAGS='-Werror' make V=1 -C tests clean test-lz4c32 || (echo SUCCESS!!  But set RED to suggest to update the test case && $(exit 1))
        echo We ignore failure of this case for now.

    #                                                             #
    #                                                             #
    ###############################################################
